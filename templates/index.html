<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MultiDocChat</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <meta name="color-scheme" content="light dark" />
  <script>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);
    let sessionId = localStorage.getItem('mdc_session_id') || '';
    let sessions = JSON.parse(localStorage.getItem('mdc_sessions') || '{}');

    function typeMessage(element, text, speed = 15) {
      return new Promise((resolve) => {
        element.textContent = '';
        let i = 0;
        const type = () => {
          if (i < text.length) {
            element.textContent += text[i];
            i++;
            setTimeout(type, speed);
          } else {
            resolve();
          }
        };
        type();
      });
    }

    async function uploadFiles(evt) {
      evt?.preventDefault();
      const input = $('#file-input');
      const files = input.files;
      if (!files || files.length === 0) {
        toast('Please choose at least one file');
        return;
      }
      
      // Show file preview
      showFilePreview(files);
      toggleIndexing(true);
      
      try {
        const fd = new FormData();
        for (const f of files) fd.append('files', f);
        console.log('Uploading', files.length, 'file(s)...');
        
        const res = await fetch('/upload', { method: 'POST', body: fd });
        console.log('Upload response status:', res.status, res.statusText);
        
        if (!res.ok) {
          let errorMsg = 'Upload failed';
          try {
            const errData = await res.json();
            errorMsg = errData.detail || `Server error: ${res.status}`;
          } catch {
            errorMsg = `Server error: ${res.status} ${res.statusText}`;
          }
          throw new Error(errorMsg);
        }
        
        let data;
        try {
          data = await res.json();
          console.log('Upload response data:', data);
        } catch (parseErr) {
          console.error('Failed to parse response:', parseErr);
          throw new Error('Invalid server response (failed to parse JSON)');
        }
        
        if (!data.session_id) {
          console.error('Missing session_id in response:', data);
          throw new Error('Invalid response: missing session_id');
        }
        
        sessionId = data.session_id;
        console.log('Session ID saved:', sessionId);
        localStorage.setItem('mdc_session_id', sessionId);
        
        // Save session
        sessions[sessionId] = {
          id: sessionId,
          files: Array.from(files).map(f => f.name),
          createdAt: new Date().toISOString()
        };
        localStorage.setItem('mdc_sessions', JSON.stringify(sessions));
        
        $('#chat').classList.remove('hidden');
        $('#uploader').style.opacity = '0.6';
        toast('âœ“ Indexing complete. You can chat now.');
        updateSessionList();
      } catch (e) {
        console.error('Upload error:', e);
        toast('âœ— ' + e.message);
      } finally {
        toggleIndexing(false);
      }
    }

    function showFilePreview(files) {
      const preview = $('#file-preview');
      if (!preview) return;
      preview.innerHTML = '<div class="file-list">';
      Array.from(files).forEach(f => {
        const item = document.createElement('div');
        item.className = 'file-item';
        item.innerHTML = `<span class="file-icon">ðŸ“„</span><span class="file-name">${f.name}</span><span class="file-size">${(f.size / 1024).toFixed(1)}KB</span>`;
        preview.querySelector('.file-list').appendChild(item);
      });
      preview.innerHTML += '</div>';
      preview.style.display = 'block';
    }

    function updateSessionList() {
      const list = $('#session-list');
      if (!list) return;
      list.innerHTML = '';
      
      if (Object.keys(sessions).length === 0) {
        list.innerHTML = '<p class="muted">No sessions yet â€” upload documents to start</p>';
        return;
      }
      
      Object.entries(sessions).forEach(([id, sess]) => {
        const item = document.createElement('div');
        item.className = 'session-item ' + (id === sessionId ? 'active' : '');
        
        const main = document.createElement('div');
        main.className = 'sess-main';
        main.innerHTML = `<strong>${sess.files ? sess.files[0] : 'Session'}</strong><span class="sess-time">${new Date(sess.createdAt).toLocaleDateString()}</span>`;
        
        const btn = document.createElement('button');
        btn.className = 'sess-btn';
        btn.textContent = 'Load';
        btn.setAttribute('data-session-id', id);
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          loadSession(id);
        });
        
        item.appendChild(main);
        item.appendChild(btn);
        list.appendChild(item);
      });
    }

    function loadSession(id) {
      console.log('Loading session:', id);
      
      if (!id || !sessions[id]) {
        console.error('Session not found:', id);
        toast('Session not found');
        return;
      }
      
      sessionId = id;
      localStorage.setItem('mdc_session_id', sessionId);
      console.log('Session set to:', sessionId);
      
      // Show chat panel
      const chatPanel = $('#chat');
      if (chatPanel) {
        chatPanel.classList.remove('hidden');
        console.log('Chat panel shown');
      }
      
      // Clear previous messages
      const msgContainer = $('#messages');
      if (msgContainer) {
        msgContainer.innerHTML = '';
        console.log('Messages cleared');
      }
      
      // Update session list to show active state
      updateSessionList();
      
      toast('âœ“ Session loaded: ' + sessions[id].files[0]);
    }

    async function sendMessage() {
      const input = $('#message-input');
      const text = input.value.trim();
      if (!sessionId) { toast('Please upload documents first.'); return; }
      if (!text) return;
      
      appendMessage('user', text);
      input.value = '';
      autoResizeTextarea();
      
      // Create loader bubble for assistant response
      const loaderBubble = appendMessage('assistant', '', true);
      toggleThinking(true);
      
      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sessionId, message: text })
        });
        if (!res.ok) throw new Error((await res.json()).detail || 'Chat failed');
        const data = await res.json();
        
        // Replace loader bubble with actual message
        if (loaderBubble) {
          loaderBubble.classList.remove('typing');
          loaderBubble.innerHTML = '';
          await typeMessage(loaderBubble, data.answer, 8);
        }
      } catch (e) {
        console.error(e);
        toast('Thinking failed. Try again.');
        if (loaderBubble) {
          loaderBubble.textContent = 'Error: Failed to get response. Try again.';
          loaderBubble.classList.remove('typing');
        }
      } finally {
        toggleThinking(false);
      }
    }

    function appendMessage(role, text, isLoader = false) {
      const container = $('#messages');
      const wrap = document.createElement('div');
      wrap.className = 'message-row ' + (role === 'user' ? 'right' : 'left');
      wrap.style.animation = 'slideIn 0.3s ease-out';
      
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (role === 'user' ? 'user' : 'assistant');
      
      if (isLoader) {
        bubble.classList.add('typing');
        bubble.innerHTML = '<span class="dots"><span></span><span></span><span></span></span>';
      } else if (role === 'user') {
        bubble.textContent = text;
      } else {
        bubble.textContent = text;
      }
      
      wrap.appendChild(bubble);
      container.appendChild(wrap);
      container.scrollTop = container.scrollHeight;
      
      return bubble;
    }

    function toggleIndexing(on) {
      $('#upload-btn').disabled = on;
      const sp = $('#indexing');
      if (sp) sp.style.display = on ? 'inline-block' : 'none';
    }

    function toggleThinking(on) {
      $('#send-btn').disabled = on;
      const sp = $('#thinking');
      if (sp) sp.style.display = on ? 'inline-block' : 'none';
    }

    function autoResizeTextarea() {
      const ta = $('#message-input');
      ta.style.height = 'auto';
      ta.style.height = Math.min(ta.scrollHeight, 160) + 'px';
    }

    function toast(msg) {
      const el = $('#toast');
      el.textContent = msg;
      el.classList.add('visible');
      clearTimeout(window._toastTimer);
      window._toastTimer = setTimeout(() => el.classList.remove('visible'), 3500);
    }

    window.addEventListener('DOMContentLoaded', () => {
      console.log('Page loaded. Current sessionId:', sessionId);
      console.log('Available sessions:', Object.keys(sessions));
      
      // If we have a stored session, load it
      if (sessionId && sessions[sessionId]) {
        console.log('Auto-loading saved session:', sessionId);
        const chatPanel = $('#chat');
        if (chatPanel) {
          chatPanel.classList.remove('hidden');
        }
      }
      
      updateSessionList();
      
      $('#upload-form').addEventListener('submit', uploadFiles);
      $('#send-btn').addEventListener('click', sendMessage);
      $('#message-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
      });
      $('#message-input').addEventListener('input', autoResizeTextarea);

      const drop = $('#dropzone');
      ['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, (e) => { e.preventDefault(); drop.classList.add('hover'); }));
      ['dragleave','drop','dragend'].forEach(ev => drop.addEventListener(ev, () => drop.classList.remove('hover')));
      drop.addEventListener('drop', (e) => {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files && files.length) $('#file-input').files = files;
      });
    });
  </script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <svg class="logo" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2L2 7v10l10 5 10-5V7L12 2z"/></svg>
      <div>
        <h1>MultiDocChat</h1>
        <p class="tag">Ask questions over your documents</p>
      </div>
    </div>
    <nav>
      <button id="upload-btn-top" class="ghost" onclick="document.getElementById('file-input').click()">Upload Files</button>
    </nav>
  </header>

  <div class="container">
    <aside class="sidebar">
      <section class="card">
        <h3>Upload & Index</h3>
        <form id="upload-form">
          <div id="dropzone" class="dropzone" aria-label="File drop area">
            <div class="dz-content">
              <p class="dz-title">Drag & drop files here</p>
              <p class="dz-sub">PDF, TXT, DOCX â€” multi-file supported</p>
              <input id="file-input" type="file" name="files" multiple hidden />
              <div class="dz-actions">
                <label class="btn" for="file-input">Choose files</label>
                <button id="upload-btn" class="primary" type="submit">Upload & Index</button>
              </div>
            </div>
          </div>
          <div id="file-preview" style="display:none;margin-top:12px"></div>
          <div class="status-row">
            <span id="indexing" class="muted" style="display:none">Indexingâ€¦</span>
          </div>
        </form>
      </section>

      <section class="card sessions">
        <h3>Sessions</h3>
        <div id="session-list" class="session-list">
          <p class="muted">No sessions yet â€” upload documents to start</p>
        </div>
      </section>
    </aside>

    <main class="workspace">
      <section id="chat" class="chat-panel hidden">
        <div class="messages" id="messages" role="log" aria-live="polite"></div>
        <div class="composer">
          <textarea id="message-input" rows="2" placeholder="Ask about your documentsâ€¦" aria-label="Message input"></textarea>
          <div class="composer-actions">
            <button id="send-btn" class="primary">Send</button>
            <span id="thinking" class="muted" style="display:none">Thinkingâ€¦</span>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
</body>
</html>